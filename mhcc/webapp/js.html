<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  /*
   * Once chart libraries load,
   *   Run the function loadUserData (located on crownHistoryPlots.gs)
   *   If the data loaded successfully, we run the function dataLoadedOK           (defined below)
   *   If the data did not load successfully, we run the function dataNotLoadedOK  (defined below)
   */
  function loadData(uid){
    google.script.run.withSuccessHandler(dataLoadedOK).withFailureHandler(dataNotLoadedOK).loadUserData(uid);
  };
  /*
   * Some error occurred while loading the user's crown and rank data. Based on the passed parameter
   * 'e', we could determine which had the error and attempt to reload it
   */
  function dataNotLoadedOK(e){
    document.getElementById('crownHistory').innerHTML = e.message;
    document.getElementById('rankHistory').innerHTML = "";
  }
  // Global chart handles to enable redrawing
  var rhWrapper, chWrapper;
  /*
   * No error occurred while loading the crown and rank data. Use the passed data to plot
   * @param {Object} input  an object with properties 'crownHistory','rankHistory', and memberName
   */
  function dataLoadedOK(input){
    if ( input.length > 0 ) {
      // Crown History (Bronze as Line, Silver & Gold as stacked area, Total as Line
      input.crownHistory = [].concat(input.crownHeader, input.crownData.map(function(value,index){return [new Date(value[0]), value[1], value[2], value[3], value[4]]}));
      var ch = google.visualization.arrayToDataTable(input.crownHistory,false); // First row is headers
      var chOptions = {title:String(input.memberName+'\'s Crowns History'),
                       hAxis:{title:'Snapshot Date'},
                       vAxis:{title:'Crown Counts',minValue:0},
                       seriesType: 'steppedArea',
                       isStacked: true,
                       series: {0: {type: 'line'},3: {type: 'line'}},
                       colors:['brown','silver','gold','black'],
                       focusTarget: 'category',
                       explorer: {axis:'horizontal', keepInBounds:true}
                      }
      chWrapper = new google.visualization.ChartWrapper({
                                containerId:'crownHistory',
                                chartType:'ComboChart',
                                dataTable:ch,
                                options:chOptions
                               });
      chWrapper.draw();

      // Rank History (Rank 1 at top)
      input.rankHistory = [].concat(input.rankHeader, input.rankData.map(function(value,index){return [new Date(value[0]), value[1], value[2]+" crowns:\nRank: "+value[1]]}));
      var rh = google.visualization.arrayToDataTable(input.rankHistory,false);  // First row is headers, cols of ranktime | rank | #mhcc
      rh.setColumnProperty(2,'role','tooltip');
      var rhOptions = {title:String(input.memberName+'\'s MHCC Rank History'),
                       hAxis:{title:'Ranking Date'},
                       vAxis:{title:'Rank',direction:-1,minValue:1, logScale:false},
                       explorer: {axis:'horizontal', keepInBounds:true}
                      }
      rhWrapper = new google.visualization.ChartWrapper({
                                containerId:'rankHistory',
                                chartType:'LineChart',
                                dataTable:rh,
                                options:rhOptions
                               });
      rhWrapper.draw();

    }
  }

  google.charts.load('current', {packages:['corechart']});
  google.charts.setOnLoadCallback(loadData(document.getElementById('member').innerHTML));

  // Ensure the charts redraw if the browser window is resized, the phone is rotated, etc.
  $(window).resize(function(){
      if (this.resizeTO) clearTimeout(this.resizeTO);
      this.resizeTO = setTimeout(function(){ $(this).trigger('resizeEnd');}, 500);
    });
  $(window).on('resizeEnd',function(){
       rhWrapper.draw();
       chWrapper.draw();
    });
</script>
